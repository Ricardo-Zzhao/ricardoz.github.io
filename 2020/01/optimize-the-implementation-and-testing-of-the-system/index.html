<!doctype html><html lang=zh-cn dir=content/zh-cn><head><meta charset=utf-8><meta http-equiv=x-ua-compatible content="IE=edge,chrome=1"><meta name=viewport content="width=device-width,initial-scale=1,maximum-scale=1"><meta http-equiv=content-security-policy content="upgrade-insecure-requests"><title>研究记录11-新访问控制方案的实现与测试 - 书藏的博客</title><meta name=keywords content="博客,程序员,区块链，思考,读书,笔记,生活,电影,旅游,"><meta name=author content="书藏"><meta property="og:title" content="研究记录11-新访问控制方案的实现与测试"><meta property="og:site_name" content="书藏的博客"><meta property="og:image" content="/img/avatar.png"><meta name=title content="研究记录11-新访问控制方案的实现与测试 - 书藏的博客"><meta name=description content="书藏的个人博客，记录学习的东西，以月刊记录生活"><link rel="shortcut icon" href=/img/favicon.ico><link rel=apple-touch-icon href=/img/apple-touch-icon.png><link rel=apple-touch-icon-precomposed href=/img/apple-touch-icon.png><link href=//cdn.bootcdn.net/ajax/libs/font-awesome/4.6.2/css/font-awesome.min.css rel=stylesheet type=text/css><link href=//cdn.bootcdn.net/ajax/libs/imageviewer/0.1.0/viewer.min.css rel=stylesheet><link href=/css/main.css rel=stylesheet type=text/css><link href=/css/syntax.css rel=stylesheet type=text/css><script async src="https://www.googletagmanager.com/gtag/js?id=UA-209130979-1"></script><script type=text/javascript>window.dataLayer=window.dataLayer||[];function gtag(){dataLayer.push(arguments);}
gtag('js',new Date());gtag('config','UA-209130979-1 ');</script></head><body itemscope itemtype=http://schema.org/WebPage lang=zh-hans><div class="container one-collumn sidebar-position-left page-home"><div class=headband></div><header id=header class=header itemscope itemtype=http://schema.org/WPHeader><div class=header-inner><div class=site-brand-container><div class=site-nav-toggle><div class=toggle role=button style=opacity:1;top:0><span class=toggle-line></span><span class=toggle-line></span><span class=toggle-line></span></div></div><div class=site-meta><div class=multi-lang-switch><i class="fa fa-fw fa-language" style=margin-right:5px></i><a class=lang-link id=zh-cn href=#>中文</a></div><div class=custom-logo-site-title><a href=/ class=brand rel=start><span class=logo-line-before><i></i></span><span class=site-title>书藏的博客</span>
<span class=logo-line-after><i></i></span></a></div><p class=site-subtitle>凡心所向，素履以往</p></div><div class=site-nav-right><div class="toggle popup-trigger" style=opacity:1;top:0><i class="fa fa-search fa-fw fa-lg"></i></div></div></div><nav class=site-nav><ul id=menu class=menu><li class=menu-item><a href=/ rel=section><i class="menu-item-icon fa fa-fw fa-home"></i><br>首页</a></li><li class=menu-item><a href=/post rel=section><i class="menu-item-icon fa fa-fw fa-archive"></i><br>归档</a></li><li class=menu-item><a href=/about.html rel=section><i class="menu-item-icon fa fa-fw fa-user"></i><br>关于我</a></li><li class="menu-item menu-item-search"><a href=javascript:; class=popup-trigger><i class="menu-item-icon fa fa-search fa-fw"></i><br>搜索</a></li></ul><div class=site-search><div class="popup search-popup local-search-popup"><div class="local-search-header clearfix"><span class=search-icon><i class="fa fa-search"></i></span><span class=popup-btn-close><i class="fa fa-times-circle"></i></span><div class=local-search-input-wrapper><input autocomplete=off placeholder=搜索关键字... spellcheck=false type=text id=local-search-input autocapitalize=none autocorrect=off></div></div><div id=local-search-result></div></div></div></nav></div></header><main id=main class=main><div class=main-inner><div class=content-wrap><div id=content class=content><section id=posts class=posts-expand><article class="post post-type-normal" itemscope itemtype=http://schema.org/Article><header class=post-header><h1 class=post-title itemprop="name headline"><a class=post-title-link href=https://shuzang.github.io/2020/01/optimize-the-implementation-and-testing-of-the-system/ itemprop=url>研究记录11-新访问控制方案的实现与测试</a></h1><div class=post-meta><span class=post-time><i class="fa fa-calendar-o fa-fw"></i><span class=post-meta-item-text>时间：</span>
<time itemprop=dateCreated datetime=2016-03-22T13:04:35+08:00 content="2020-01-15">2020-01-15</time></span>
<span class=post-category>&nbsp; | &nbsp;
<i class="fa fa-folder-o fa-fw"></i><span class=post-meta-item-text>分类：</span>
<span itemprop=about itemscope itemtype=https://schema.org/Thing><a href=/categories/%E7%A0%94%E7%A9%B6%E7%94%9F%E7%9A%84%E5%8C%BA%E5%9D%97%E9%93%BE%E5%AD%A6%E4%B9%A0%E4%B9%8B%E8%B7%AF itemprop=url rel=index style=text-decoration:underline><span itemprop=name>研究生的区块链学习之路</span></a>
&nbsp;</span></span>
<span>|
<i class="fa fa-file-word-o fa-fw"></i><span class=post-meta-item-text>字数：</span>
<span class=leancloud-world-count>6005 字</span></span>
<span>|
<i class="fa fa-eye fa-fw"></i><span class=post-meta-item-text>阅读：</span>
<span class=leancloud-view-count>12分钟</span></span>
<span id=/2020/01/optimize-the-implementation-and-testing-of-the-system/ class=leancloud_visitors data-flag-title=研究记录11-新访问控制方案的实现与测试>|
<i class="fa fa-binoculars fa-fw"></i><span class=post-meta-item-text>阅读次数：</span>
<span class=leancloud-visitors-count></span></span></div></header><div class=post-body itemprop=articleBody><p>根据之前几篇文章的分析，我们对优化后的新方案进行了实现，本篇介绍新方案的一些测试与验证过程。代码可以参考 BBRAC 仓库的 <a href=https://github.com/shuzang/BBRAC/tree/truffle>truffle</a> 分支，但是该分支包括后面添加的恶意行为检测的内容，是进行了二次完善后的代码。</p><h2 id=1-智能合约>1. 智能合约</h2><p>新的合约系统中依然包含Register Contract（注册合约，RC），Access Control Contract（访问控制合约，ACC）和 Judge Contract（判决合约，JC）三种合约。</p><h3 id=11-gas消耗统计>1.1 Gas消耗统计</h3><p>三个合约部署的Gas消耗统计如下</p><table><thead><tr><th>合约名</th><th>transaction cost</th><th>execution cost</th></tr></thead><tbody><tr><td>RC</td><td>3285811 gas</td><td>2457443 gas</td></tr><tr><td>ACC</td><td>5380922 gas</td><td>4047334 gas</td></tr><tr><td>JC</td><td>1375161 gas</td><td>1002445 gas</td></tr></tbody></table><p>消耗的代币数量 = gas × gasprice，gasprice的货币单位决定代币的货币单位。</p><p>在Quorum网络中，这些Gas消耗没有实际意义，因为gasprice = 0，合约部署前会判断用户是否拥有足够的gas，但不会真的扣除。</p><h3 id=12-合约功能说明>1.2 合约功能说明</h3><p>RC实现的功能大致分为两类，第一部分对合约进行管理，第二部分对属性进行管理</p><p>ACC实现的功能分为三类，第一部分对设备自身拥有的资源属性进行管理，第二部分对访问控制策略进行管理，第三部分是访问控制函数</p><p>JC实现两个函数，第一个是恶意行为判决，第二个用来查询恶意行为</p><h2 id=2-审计>2. 审计</h2><p>智能合约的安全性非常重要，行业内对智能合约进行安全性分析称之为「审计」</p><h3 id=21-工具选取>2.1 工具选取</h3><p>基本的思路是选取合适的自动审计工具来对编写完成的合约进行分析，参考了 <a href=https://learnblockchain.cn/2019/10/15/VaasMythril/>关于形式化验证两大工具 (Vass & Mythril) 测试对比</a> 这篇文章。</p><p>在经过大量查找后发现，商业化应用的审计工具以上文中提到的这两款（Vass 和 Mythril） 最为普及。我们首先使用成都链安的 Vass 工具进行分析，然而发现，在合约中存在内联汇编时，Vass 无法编译合约，更谈不上审计，然而内联汇编在我们的合约中是必要的，因此换用 Mythril。</p><p>工具是由以太坊开源社区所提供的安全分析工具，而建立在Mythril上的合约分析平台 <a href=https://github.com/b-mueller/awesome-mythx-smart-contract-security-tools>MythX</a>具有更高的可用性并覆盖了更广泛的安全问题，因此最终使用MythX 完成统计分析。MythX 拥有 Remix、VScode 和 Truffle 的插件，因此无论以哪种方式编辑合约，都可以轻松的进行安全分析，但首先需要拥有 MythX 的账户。</p><p>首先在 <a href=https://dashboard.mythx.io/#/registration>https://dashboard.mythx.io/#/registration</a> 页面使用邮箱进行注册，之后关联 MetaMask 以太坊账户，MythX 将提供一个密码供 Remix 等工具中的插件使用，也可以自己设定，但设定的密码要求长度为 6-64 位，至少一个小写字符，一个大写字符，一个数字和一个符号，该要求的原文如下：</p><div class=highlight><pre style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-fallback data-lang=fallback>Password needs to contain: Length: 8 and 64 characters; One lowercase (a-z) and uppercase (A-Z) letter; One digit (0-9); One symbol (e.g. !&#34;#$%&amp;/()., )
</code></pre></div><h3 id=22-审计>2.2 审计</h3><p>打开 Remix 界面，在插件列表搜索 MythX，点击<code>Activate</code>将插件激活。</p><p>以 Remix 自带的示例合约 ballot.sol 为例，首先编译该合约，然后切换到 MythX 选项卡，输入之前关联到 MythX 的以太坊账户地址，MythX 提供的或自己更改后的密码，点击<code>Save</code>，然后点击<code>Analyze</code></p><p><img src=https://picped-1301226557.cos.ap-beijing.myqcloud.com/YJS_20200115_8lZdFe.png alt=登录并进行分析></p><p>经过一段时间的等待后，将可以在<code>Report</code>界面查看到安全分析结果</p><p><img src=https://picped-1301226557.cos.ap-beijing.myqcloud.com/YJS_20200115_8lZcef.png alt=查看分析结果></p><p>也可以点击上图 Log 记录中的链接进入 MythX Dashboard 查看详细结果</p><p><img src=https://picped-1301226557.cos.ap-beijing.myqcloud.com/YJS_20200115_8lZfYQ.png alt=详细分析结果></p><p>点击<code>Analysed Files</code>查看错误的详细位置与说明，然后更改源代码，重新测试，直到合约安全性达到自己想要的结果。</p><p><img src=https://picped-1301226557.cos.ap-beijing.myqcloud.com/YJS_20200115_8lZoyq.png alt=迭代修改></p><p>检测到的合约弱点(漏洞)以SWC-XXX编号的形式出现，由 <a href=https://swcregistry.io/>https://swcregistry.io/</a> 可查看完整的安全问题列表和解释。但是，免费的 MythX 只能检测10种安全问题，Pro版和企业版可以检测26种安全问题，具体对每种安全问题的支持程度见该页面： <a href=https://mythx.io/swc-coverage/>https://mythx.io/swc-coverage/</a></p><p>当前调试过程种，遇到的典型安全问题是 SWC-101:Integer Overflow and Underflow 问题，问题的具体分析可参考 <a href=https://github.com/ethereum/solidity/issues/796>solidity-issue #796</a></p><h3 id=23-审计结果>2.3 审计结果</h3><p>我们所编写的 RC，ACC 和 JC 三个合约在经过多次修改后，将出现的安全问题降低到了可接受的程度，如下图所示</p><p><img src=https://picped-1301226557.cos.ap-beijing.myqcloud.com/YJS_20200115_8leP0K.png alt=访问控制合约检测结果></p><p>三个合约出现的低级安全问题均为SWC-103: Floating Pragma ，即编译器的版本指定为一个范围，但这样具有更好的适用性，因此不进行修改</p><div class=highlight><pre style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-js data-lang=js> pragma solidity <span style=color:#666>&gt;=</span><span style=color:#666>0.4</span><span style=color:#666>.22</span> <span style=color:#666>&lt;</span><span style=color:#666>0.6</span><span style=color:#666>.0</span>;
</code></pre></div><p>ACC出现的15个中级安全问题在详情列表中无法查看</p><p><img src=https://picped-1301226557.cos.ap-beijing.myqcloud.com/YJS_20200115_8leZpd.png alt=ACC的安全问题></p><p>邮件询问后官方的回复如下，字节码级别的错误如果不依靠安全工具很难检出并修正，因此我们只能忽略掉这些安全问题。</p><blockquote><p><strong>Josh Reid</strong> (MythX)</p><p>Dec 5, 11:11 AST</p><p>Hello,</p><p>Thanks for reaching out to MythX support! We are currently investigating any potential issues that may be causing these vulnerabilities to not be displayed fully, however this may also be due to the vulnerabilities being detected only on the bytecode.</p><p>Unfortunately, at this time we do no have the ability to display bytecode vulnerabilities as we cannot specify where they are. However, this is something we are looking to evaluate and differentiate on more as we go forward. I apologize for any confusion this may have caused and will be sure to update you if we find any issues as we continue to look into this. In the meantime, thanks so much for your patience and cooperation! Is there anything else I can help you with at this time?</p><p>Best,</p><p>Josh</p></blockquote><h2 id=3-系统测试>3. 系统测试</h2><p>本节介绍合约在 Quorum 区块链网络中的部署过程和访问控制的测试实现。由于论文复现的时候发现手动配置的复杂性太高，极易出错，而一旦出错就必须重来，因此这次的优化实验决定使用 truffle 进行部署测试。</p><h3 id=31-账户设置>3.1 账户设置</h3><p>按设计，Raspberry Pi 3B+ 是 lightnode1，Raspberry Pi 3B 是 linghtnode2。区块链网络启动后，四个 validator 各有 10<sup>50</sup> wei(10<sup>18</sup>是 1 ether)，但是后面加入区块链网络的两台树莓派是普通节点，余额为 0，所以首先由 node0 向两个账户分别转账 1 ether。</p><div class=highlight><pre style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=color:#080;font-style:italic># lightnode1账户地址为：&#34;0x77c22157a3b8840d34b8ed5975b5f2597bd6a7a2&#34;</span>
<span style=color:#080;font-style:italic># lightnode2账户地址为：&#34;0xa31d40508da63fb00d7e2f4db57c3774384aa299&#34;</span>
</code></pre></div><p>在 node0 的 geth console 中解锁账户，并分别向 lightnode1 和 lightnode2 转账 1 ether</p><div class=highlight><pre style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-js data-lang=js><span style=color:#666>&gt;</span> eth.accounts
[<span style=color:#b44>&#34;0xbffe4ff0cbd0a7590fb71966d1e6bb1a4c2359e0&#34;</span>]
<span style=color:#666>&gt;</span> eth.getBalance(eth.accounts[<span style=color:#666>0</span>])
<span style=color:#666>1</span>e<span style=color:#666>+</span><span style=color:#666>50</span>
<span style=color:#666>&gt;</span> personal.unlockAccount(eth.accounts[<span style=color:#666>0</span>])
Unlock account <span style=color:#666>0xbffe4ff0cbd0a7590fb71966d1e6bb1a4c2359e0</span>
Passphrase<span style=color:#666>:</span> 
<span style=color:#a2f;font-weight:700>true</span>
<span style=color:#666>&gt;</span> 
<span style=color:#666>&gt;</span> eth.sendTransaction({from<span style=color:#666>:</span>eth.accounts[<span style=color:#666>0</span>], to<span style=color:#666>:</span><span style=color:#b44>&#34;0x77c22157a3b8840d34b8ed5975b5f2597bd6a7a2&#34;</span>, value<span style=color:#666>:</span><span style=color:#666>1</span><span style=color:#666>*</span><span style=color:#666>1</span>e18})
<span style=color:#b44>&#34;0x3ed3cbc568a64dff3c3fe4a00b87d259d2299953c47e284b19253299eb8c4725&#34;</span>
<span style=color:#666>&gt;</span> eth.sendTransaction({from<span style=color:#666>:</span>eth.accounts[<span style=color:#666>0</span>], to<span style=color:#666>:</span><span style=color:#b44>&#34;0xa31d40508da63fb00d7e2f4db57c3774384aa299&#34;</span>, value<span style=color:#666>:</span><span style=color:#666>1</span><span style=color:#666>*</span><span style=color:#666>1</span>e18})
<span style=color:#b44>&#34;0xc9e4193164d38d94502960fcc0d1d7c2e22a9f04307145945c4ae525c6d99aee&#34;</span>
<span style=color:#666>&gt;</span> eth.getBalance(eth.accounts[<span style=color:#666>0</span>])
<span style=color:#666>9.9999999999999999999999999999998e+49</span>
</code></pre></div><p>在 lightnode1 和 lightnode2 的 geth console 执行下列命令查询余额，由结果可知转账成功。</p><div class=highlight><pre style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-js data-lang=js><span style=color:#666>&gt;</span> web3.fromWei(eth.getBalance(eth.accounts[<span style=color:#666>0</span>]), <span style=color:#b44>&#34;ether&#34;</span>)
<span style=color:#666>1</span>
</code></pre></div><p>两台树莓派担任的角色是网关，用于管理 IoT 设备，因此分别在 lightnode1 和 lightnode2 中建立新账户，用来代表 IoT 设备，由网关向各自管理的设备转账 10<sup>7</sup> wei，以供使用。</p><div class=highlight><pre style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-js data-lang=js><span>#</span> lightnode1
<span style=color:#666>&gt;</span> personal.newAccount()
Passphrase<span style=color:#666>:</span>
Repeat passphrase<span style=color:#666>:</span>
<span style=color:#b44>&#34;0x9a4aa696f85c6bf96733cc5385ccaf2b7ee13f17&#34;</span>
<span style=color:#666>&gt;</span> personal.listAccounts
[<span style=color:#b44>&#34;0x77c22157a3b8840d34b8ed5975b5f2597bd6a7a2&#34;</span>, <span style=color:#b44>&#34;0x9a4aa696f85c6bf96733cc5385ccaf2b7ee13f17&#34;</span>]
<span style=color:#666>&gt;</span> personal.unlockAccount(eth.accounts[<span style=color:#666>0</span>])
Unlock account <span style=color:#666>0x77c22157a3b8840d34b8ed5975b5f2597bd6a7a2</span>
Passphrase<span style=color:#666>:</span>
<span style=color:#a2f;font-weight:700>true</span>
<span style=color:#666>&gt;</span> eth.sendTransaction({from<span style=color:#666>:</span>eth.accounts[<span style=color:#666>0</span>],to<span style=color:#666>:</span>eth.accounts[<span style=color:#666>1</span>],value<span style=color:#666>:</span><span style=color:#666>1</span><span style=color:#666>*</span><span style=color:#666>1</span>e7})
<span style=color:#b44>&#34;0x35bda063bc28ff3ef68b78962f427e930824390c4d1a8857c98e2dcf70485e17&#34;</span>
<span style=color:#666>&gt;</span> eth.getBalance(eth.accounts[<span style=color:#666>1</span>])
<span style=color:#666>10000000</span> 

<span>#</span> lightnode2
<span style=color:#666>&gt;</span> personal.newAccount()
Passphrase<span style=color:#666>:</span> 
Repeat passphrase<span style=color:#666>:</span> 
<span style=color:#b44>&#34;0x016b71d115f1da36de58d2b78369fd3228bef3dd&#34;</span>
<span style=color:#666>&gt;</span> personal.listAccounts
[<span style=color:#b44>&#34;0xa31d40508da63fb00d7e2f4db57c3774384aa299&#34;</span>, <span style=color:#b44>&#34;0x016b71d115f1da36de58d2b78369fd3228bef3dd&#34;</span>]
<span style=color:#666>&gt;</span> personal.unlockAccount(eth.accounts[<span style=color:#666>0</span>])
Unlock account <span style=color:#666>0xa31d40508da63fb00d7e2f4db57c3774384aa299</span>
Passphrase<span style=color:#666>:</span> 
<span style=color:#a2f;font-weight:700>true</span>
<span style=color:#666>&gt;</span> eth.sendTransaction({from<span style=color:#666>:</span>eth.accounts[<span style=color:#666>0</span>],to<span style=color:#666>:</span>eth.accounts[<span style=color:#666>1</span>],value<span style=color:#666>:</span><span style=color:#666>1</span><span style=color:#666>*</span><span style=color:#666>1</span>e7})
<span style=color:#b44>&#34;0x96bc2b359219c72ff4f2ce910c27d4c76649685a8f9cfd1b879938317c9a1fe1&#34;</span>
<span style=color:#666>&gt;</span> eth.getBalance(eth.accounts[<span style=color:#666>1</span>])
<span style=color:#666>10000000</span>
</code></pre></div><p>至此账户设置完成，接下来将 truffle 连接到 quorum 网络，部署合约</p><h3 id=32-安装truffle>3.2 安装Truffle</h3><p>在 Ubuntu18.04 下安装运行，要求 Node.js 版本高于 v8.9.4，这里全都升级到了最新</p><div class=highlight><pre style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash>$ sudo apt-get install npm
$ sudo npm install npm@latest -g
$ sudo npm install n -g
$ sudo n lts
</code></pre></div><p>安装 Truffle</p><div class=highlight><pre style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash>$ sudo npm install -g truffle
$ truffle version
Truffle v5.1.5 <span style=color:#666>(</span>core: 5.1.5<span style=color:#666>)</span>
Solidity v0.5.12 <span style=color:#666>(</span>solc-js<span style=color:#666>)</span>
Node v12.14.0
Web3.js v1.2.1
</code></pre></div><h3 id=33-创建项目和基本配置>3.3 创建项目和基本配置</h3><p>建立空项目</p><div class=highlight><pre style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash>$ mkdir AC
$ <span style=color:#a2f>cd</span> AC
</code></pre></div><p>初始化项目</p><div class=highlight><pre style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash>$ truffle init
✔ Preparing to download box
✔ Downloading
✔ cleaning up temporary files
✔ Setting up box
</code></pre></div><p>项目文件夹中出现相关文件说明成功，此时没有任何合约和测试代码</p><div class=highlight><pre style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash>$ ls
contracts  migrations  <span style=color:#a2f>test</span>  truffle-config.js
</code></pre></div><p>修改<code>truffle-config.js</code>文件进行配置，使其关联到已建立的 quorum 网络</p><div class=highlight><pre style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-js data-lang=js><span style=color:#080;font-style:italic>// truffle-config.js
</span><span style=color:#080;font-style:italic></span>module.exports <span style=color:#666>=</span> {
  networks<span style=color:#666>:</span> {
     development<span style=color:#666>:</span> {
       host<span style=color:#666>:</span> <span style=color:#b44>&#34;192.168.191.2&#34;</span>,  <span style=color:#080;font-style:italic>// Localhost (default: none)
</span><span style=color:#080;font-style:italic></span>       port<span style=color:#666>:</span> <span style=color:#666>22000</span>,            
       network_id<span style=color:#666>:</span> <span style=color:#b44>&#34;10&#34;</span>,       
       gasPrice<span style=color:#666>:</span> <span style=color:#666>0</span>,
       gas<span style=color:#666>:</span> <span style=color:#666>100000000</span>,
       type<span style=color:#666>:</span> <span style=color:#b44>&#34;quorum&#34;</span>    
     },
     lightnode1<span style=color:#666>:</span> {
       host<span style=color:#666>:</span> <span style=color:#b44>&#34;192.168.191.3&#34;</span>,   
       port<span style=color:#666>:</span> <span style=color:#666>22000</span>,            <span style=color:#080;font-style:italic>// Standard Ethereum port (default: none)
</span><span style=color:#080;font-style:italic></span>       network_id<span style=color:#666>:</span> <span style=color:#b44>&#34;10&#34;</span>,       
       gasPrice<span style=color:#666>:</span> <span style=color:#666>0</span>,
       gas<span style=color:#666>:</span> <span style=color:#666>10000000</span>,
       type<span style=color:#666>:</span> <span style=color:#b44>&#34;quorum&#34;</span>,
       from<span style=color:#666>:</span> <span style=color:#b44>&#34;0x9a4aa696f85c6bf96733cc5385ccaf2b7ee13f17&#34;</span>,    
       provider<span style=color:#666>:</span> <span style=color:#a2f;font-weight:700>new</span> Web3.providers.WebsocketProvider(<span style=color:#b44>&#34;ws://192.168.191.3:8545&#34;</span>)
     },
     lightnode2<span style=color:#666>:</span> {
       host<span style=color:#666>:</span> <span style=color:#b44>&#34;192.168.191.4&#34;</span>,  
       port<span style=color:#666>:</span> <span style=color:#666>22000</span>,            <span style=color:#080;font-style:italic>// Standard Ethereum port (default: none)
</span><span style=color:#080;font-style:italic></span>       network_id<span style=color:#666>:</span> <span style=color:#b44>&#34;10&#34;</span>,       
       gasPrice<span style=color:#666>:</span> <span style=color:#666>0</span>,
       gas<span style=color:#666>:</span> <span style=color:#666>10000000</span>,
       type<span style=color:#666>:</span> <span style=color:#b44>&#34;quorum&#34;</span>,
       from<span style=color:#666>:</span> <span style=color:#b44>&#34;0x016b71d115f1da36de58d2b78369fd3228bef3dd&#34;</span>,
       provider<span style=color:#666>:</span> <span style=color:#a2f;font-weight:700>new</span> Web3.providers.WebsocketProvider(<span style=color:#b44>&#34;ws://192.168.191.4:8545&#34;</span>)    
     }
  }
};
</code></pre></div><p>建立了三个网络<code>development</code>、<code>lightnode1</code>和<code>lightnode2</code>。第一个网络<code>development</code>是 node0，用来部署 RC 和 JC，第二个网络是 lightnode1，用来部署ACC，第三个网络是 lightnode2，用来发起访问控制做演示。</p><p>因为在最后设置了<code>provider</code>，使用 websocket 进行访问，所以实际上定义的<code>host</code>和<code>port</code>两个参数是被屏蔽的，主要是因为基于 http 的远程连接好像已经被启用了，只能使用 websocket。</p><p>参数的设置主要参考了以下两篇文档</p><ul><li><a href=https://www.trufflesuite.com/docs/truffle/reference/configuration>Truffle Configuration</a></li><li><a href=https://www.trufflesuite.com/tutorials/building-dapps-for-quorum-private-enterprise-blockchains>Building Dapps for Quorum:Private Enterprise Blockchains</a></li></ul><h3 id=34-部署>3.4 部署</h3><p>将 RC，ACC 和 JC 三个合约放入<code>contracts</code>文件夹，然后在项目根目录执行<code>truffle compile</code>编译命令，编译所有合约，不过编译命令可以不执行，因为下面的<code>truffle migrate</code>无论是否执行过编译都会再检查一遍，如果编译过，就忽略，如果没有编译，会自动执行编译命令。</p><p>在<code>migrations</code>文件夹新建文件<code>2_deploy_contracts.js</code>，用于部署合约，编写内容如下</p><div class=highlight><pre style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-js data-lang=js><span style=color:#a2f;font-weight:700>var</span> Register <span style=color:#666>=</span> artifacts.require(<span style=color:#b44>&#34;Register&#34;</span>);
<span style=color:#a2f;font-weight:700>var</span> Judge <span style=color:#666>=</span> artifacts.require(<span style=color:#b44>&#34;Judge&#34;</span>);
<span style=color:#a2f;font-weight:700>var</span> AccessControl <span style=color:#666>=</span> artifacts.require(<span style=color:#b44>&#34;AccessControl&#34;</span>);

module.exports <span style=color:#666>=</span> <span style=color:#a2f;font-weight:700>function</span>(deployer, network) {
  <span style=color:#a2f;font-weight:700>if</span> (network <span style=color:#666>==</span> <span style=color:#b44>&#34;lightnode1&#34;</span>) {
    deployer.deploy(AccessControl, Register.address, Judge.address);
  } <span style=color:#a2f;font-weight:700>else</span> {
    deployer.deploy(Register);
    deployer.deploy(Judge, <span style=color:#666>2</span>, <span style=color:#666>3</span>);
  }
};
</code></pre></div><p>首先从 node0 部署 RC 和 JC 两个合约，<code>truffle migrate</code>命令默认连接<code>truffle-config.js</code>配置中的<code>development</code>网络，我们之前已将该网络设置为 node0 的 ip 和端口。</p><p>注：所有<code>truffle migrate</code>和<code>truffle exec</code>命令执行前都要先对相应的账户解锁，否则无法成功</p><div class=highlight><pre style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash>$ truffle migrate
Compiling your contracts...
<span style=color:#666>=</span><span style=color:#666>=</span><span style=color:#666>=</span><span style=color:#666>=</span><span style=color:#666>=</span><span style=color:#666>=</span><span style=color:#666>=</span><span style=color:#666>=</span><span style=color:#666>=</span><span style=color:#666>=</span><span style=color:#666>=</span><span style=color:#666>=</span><span style=color:#666>=</span><span style=color:#666>=</span><span style=color:#666>=</span><span style=color:#666>=</span><span style=color:#666>=</span><span style=color:#666>=</span><span style=color:#666>=</span><span style=color:#666>=</span><span style=color:#666>=</span><span style=color:#666>=</span><span style=color:#666>=</span><span style=color:#666>=</span><span style=color:#666>=</span><span style=color:#666>=</span><span style=color:#666>=</span>
&gt; Compiling ./contracts/ACC.sol
&gt; Compiling ./contracts/JC.sol
&gt; Compiling ./contracts/Migrations.sol
&gt; Compiling ./contracts/RC.sol
&gt; Artifacts written to /home/shuzang/AC/build/contracts
&gt; Compiled successfully using:
   - solc: 0.5.12+commit.7709ece9.Emscripten.clang

Starting migrations...
<span style=color:#666>=</span><span style=color:#666>=</span><span style=color:#666>=</span><span style=color:#666>=</span><span style=color:#666>=</span><span style=color:#666>=</span><span style=color:#666>=</span><span style=color:#666>=</span><span style=color:#666>=</span><span style=color:#666>=</span><span style=color:#666>=</span><span style=color:#666>=</span><span style=color:#666>=</span><span style=color:#666>=</span><span style=color:#666>=</span><span style=color:#666>=</span><span style=color:#666>=</span><span style=color:#666>=</span><span style=color:#666>=</span><span style=color:#666>=</span><span style=color:#666>=</span><span style=color:#666>=</span>
&gt; Network name:    <span style=color:#b44>&#39;development&#39;</span>
&gt; Network id:      <span style=color:#666>10</span>
&gt; Block gas limit: 0x6dcd11a0


1_initial_migration.js
<span style=color:#666>=</span><span style=color:#666>=</span><span style=color:#666>=</span><span style=color:#666>=</span><span style=color:#666>=</span><span style=color:#666>=</span><span style=color:#666>=</span><span style=color:#666>=</span><span style=color:#666>=</span><span style=color:#666>=</span><span style=color:#666>=</span><span style=color:#666>=</span><span style=color:#666>=</span><span style=color:#666>=</span><span style=color:#666>=</span><span style=color:#666>=</span><span style=color:#666>=</span><span style=color:#666>=</span><span style=color:#666>=</span><span style=color:#666>=</span><span style=color:#666>=</span><span style=color:#666>=</span>

   Deploying <span style=color:#b44>&#39;Migrations&#39;</span>
   ----------------------
   &gt; transaction hash:    0xefb249903f558ccd7b6326f73a886356b55377a4262b34b81f5f9f2940b4347e
   &gt; Blocks: <span style=color:#666>0</span>            Seconds: <span style=color:#666>4</span>
   &gt; contract address:    0x4EC4F8BA5aEcA93955f67CFA58dbe4C57b21b37c
   &gt; block number:        <span style=color:#666>2922</span>
   &gt; block timestamp:     0x5e02bcb5
   &gt; account:             0xbfFe4ff0cBd0A7590Fb71966D1E6bb1a4c2359e0
   &gt; balance:             <span style=color:#666>99999999999999999999999999999998</span>
   &gt; gas used:            <span style=color:#666>263741</span>
   &gt; gas price:           <span style=color:#666>0</span> gwei
   &gt; value sent:          <span style=color:#666>0</span> ETH
   &gt; total cost:          <span style=color:#666>0</span> ETH


   &gt; Saving migration to chain.
   &gt; Saving artifacts
   -------------------------------------
   &gt; Total cost:                   <span style=color:#666>0</span> ETH


2_deploy_contracts.js
<span style=color:#666>=</span><span style=color:#666>=</span><span style=color:#666>=</span><span style=color:#666>=</span><span style=color:#666>=</span><span style=color:#666>=</span><span style=color:#666>=</span><span style=color:#666>=</span><span style=color:#666>=</span><span style=color:#666>=</span><span style=color:#666>=</span><span style=color:#666>=</span><span style=color:#666>=</span><span style=color:#666>=</span><span style=color:#666>=</span><span style=color:#666>=</span><span style=color:#666>=</span><span style=color:#666>=</span><span style=color:#666>=</span><span style=color:#666>=</span><span style=color:#666>=</span>

   Deploying <span style=color:#b44>&#39;Register&#39;</span>
   --------------------
   &gt; transaction hash:    0xa49e8d423980248e9c03eb52ecd3b46c15209e867285d2bc718a20620f3addd2
   &gt; Blocks: <span style=color:#666>0</span>            Seconds: <span style=color:#666>4</span>
   &gt; contract address:    0x8980FC2bBD25958d0c72F5ba5fa3e5faF1A48c05
   &gt; block number:        <span style=color:#666>2924</span>
   &gt; block timestamp:     0x5e02bcbf
   &gt; account:             0xbfFe4ff0cBd0A7590Fb71966D1E6bb1a4c2359e0
   &gt; balance:             <span style=color:#666>99999999999999999999999999999998</span>
   &gt; gas used:            <span style=color:#666>3227866</span>
   &gt; gas price:           <span style=color:#666>0</span> gwei
   &gt; value sent:          <span style=color:#666>0</span> ETH
   &gt; total cost:          <span style=color:#666>0</span> ETH


   Deploying <span style=color:#b44>&#39;Judge&#39;</span>
   -----------------
   &gt; transaction hash:    0xaf538d559ecc72949d40bbc4d1dde67dfa535c7d5a78267c4de414b51fef4bf9
   &gt; Blocks: <span style=color:#666>0</span>            Seconds: <span style=color:#666>4</span>
   &gt; contract address:    0x2C2Fb0DD2440e72318Fb018f923F78Ff86541D08
   &gt; block number:        <span style=color:#666>2925</span>
   &gt; block timestamp:     0x5e02bcc4
   &gt; account:             0xbfFe4ff0cBd0A7590Fb71966D1E6bb1a4c2359e0
   &gt; balance:             <span style=color:#666>99999999999999999999999999999998</span>
   &gt; gas used:            <span style=color:#666>1349320</span>
   &gt; gas price:           <span style=color:#666>0</span> gwei
   &gt; value sent:          <span style=color:#666>0</span> ETH
   &gt; total cost:          <span style=color:#666>0</span> ETH


   &gt; Saving migration to chain.
   &gt; Saving artifacts
   -------------------------------------
   &gt; Total cost:                   <span style=color:#666>0</span> ETH


<span style=color:#b8860b>Summary</span>
<span style=color:#666>=</span><span style=color:#666>=</span><span style=color:#666>=</span><span style=color:#666>=</span><span style=color:#666>=</span><span style=color:#666>=</span><span style=color:#666>=</span>
&gt; Total deployments:   <span style=color:#666>3</span>
&gt; Final cost:          <span style=color:#666>0</span> ETH
</code></pre></div><p>然后部署 ACC，<code>truffle migrate</code>命令指定连接网络<code>lightnode1</code>，<code>--f</code>指定部署脚本，否则因为之前该脚本已成功执行会略过，而又因为没有新的脚本而没有任何操作。<code>truffle-config.js</code>配置中的<code>lightnode1</code>网络已设置为 raspberry pi 3B+ 的 ip 和端口，默认账户设置为第二个账户，也就是新建的用于表示 IoT 设备的账户。</p><div class=highlight><pre style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash>$ truffle migrate --network linghtnode1 --f <span style=color:#666>2</span>
Compiling your contracts...
<span style=color:#666>=</span><span style=color:#666>=</span><span style=color:#666>=</span><span style=color:#666>=</span><span style=color:#666>=</span><span style=color:#666>=</span><span style=color:#666>=</span><span style=color:#666>=</span><span style=color:#666>=</span><span style=color:#666>=</span><span style=color:#666>=</span><span style=color:#666>=</span><span style=color:#666>=</span><span style=color:#666>=</span><span style=color:#666>=</span><span style=color:#666>=</span><span style=color:#666>=</span><span style=color:#666>=</span><span style=color:#666>=</span><span style=color:#666>=</span><span style=color:#666>=</span><span style=color:#666>=</span><span style=color:#666>=</span><span style=color:#666>=</span><span style=color:#666>=</span><span style=color:#666>=</span><span style=color:#666>=</span>
&gt; Everything is up to date, there is nothing to compile.



Starting migrations...
<span style=color:#666>=</span><span style=color:#666>=</span><span style=color:#666>=</span><span style=color:#666>=</span><span style=color:#666>=</span><span style=color:#666>=</span><span style=color:#666>=</span><span style=color:#666>=</span><span style=color:#666>=</span><span style=color:#666>=</span><span style=color:#666>=</span><span style=color:#666>=</span><span style=color:#666>=</span><span style=color:#666>=</span><span style=color:#666>=</span><span style=color:#666>=</span><span style=color:#666>=</span><span style=color:#666>=</span><span style=color:#666>=</span><span style=color:#666>=</span><span style=color:#666>=</span><span style=color:#666>=</span>
&gt; Network name:    <span style=color:#b44>&#39;lightnode1&#39;</span>
&gt; Network id:      <span style=color:#666>10</span>
&gt; Block gas limit: 0x67a09e29


2_deploy_contracts.js
<span style=color:#666>=</span><span style=color:#666>=</span><span style=color:#666>=</span><span style=color:#666>=</span><span style=color:#666>=</span><span style=color:#666>=</span><span style=color:#666>=</span><span style=color:#666>=</span><span style=color:#666>=</span><span style=color:#666>=</span><span style=color:#666>=</span><span style=color:#666>=</span><span style=color:#666>=</span><span style=color:#666>=</span><span style=color:#666>=</span><span style=color:#666>=</span><span style=color:#666>=</span><span style=color:#666>=</span><span style=color:#666>=</span><span style=color:#666>=</span><span style=color:#666>=</span>

   Deploying <span style=color:#b44>&#39;AccessControl&#39;</span>
   -------------------------
   &gt; transaction hash:    0xf49cca809ad273812de75225dcfe50b624bfe2a93fd2b44653491e8ee0edeb04
   &gt; Blocks: <span style=color:#666>1</span>            Seconds: <span style=color:#666>4</span>
   &gt; contract address:    0x05455fa63e5a7cb6575D75c99855cF3A1Adc72b1
   &gt; block number:        <span style=color:#666>3160</span>
   &gt; block timestamp:     0x5e02c15b
   &gt; account:             0x9A4aa696F85C6bF96733Cc5385cCaf2b7ee13f17
   &gt; balance:             0.00000000001
   &gt; gas used:            <span style=color:#666>5263918</span>
   &gt; gas price:           <span style=color:#666>0</span> gwei
   &gt; value sent:          <span style=color:#666>0</span> ETH
   &gt; total cost:          <span style=color:#666>0</span> ETH


   &gt; Saving migration to chain.
   &gt; Saving artifacts
   -------------------------------------
   &gt; Total cost:                   <span style=color:#666>0</span> ETH


<span style=color:#b8860b>Summary</span>
<span style=color:#666>=</span><span style=color:#666>=</span><span style=color:#666>=</span><span style=color:#666>=</span><span style=color:#666>=</span><span style=color:#666>=</span><span style=color:#666>=</span>
&gt; Total deployments:   <span style=color:#666>1</span>
&gt; Final cost:          <span style=color:#666>0</span> ETH

</code></pre></div><h3 id=35-合约交互>3.5 合约交互</h3><p>尝试了三种方式，在这里最后只有 truffle console 这种方式真正完成了，但理论上三种都可行，而且事实证明利用 web3.js 完成交互最方便，truffle console 还是有点繁琐。</p><h4 id=truffle-contract><del>truffle-contract</del></h4><p>truffle使用 <a href=https://github.com/trufflesuite/truffle/tree/master/packages/contract>truffle-contract</a> 接口(原文是contract abstraction，合约抽象)来交互，truffle develop的控制台、migrate写的部署脚本和基于 JS 的单元测试等都用的是这个抽象接口。</p><p>主要方式是编写JavaScript代码，使用提供的抽象接口可以调用已部署合约的函数，无论是发起交易改变合约状态还是仅仅调用获得返回结果。</p><p>在项目根目录(和<code>trufffle-config.js</code>同文件夹)创建文件<code>JCRegister.js</code>，用于注册判决合约，文件内容如下</p><div class=highlight><pre style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-js data-lang=js><span style=color:#a2f;font-weight:700>var</span> Register <span style=color:#666>=</span> artifacts.require(<span style=color:#b44>&#34;Register&#34;</span>);
<span style=color:#a2f;font-weight:700>var</span> Judge <span style=color:#666>=</span> artifacts.require(<span style=color:#b44>&#34;Judge&#34;</span>);

module.<span style=color:#a2f;font-weight:700>export</span> <span style=color:#666>=</span> <span style=color:#a2f;font-weight:700>function</span>(done) {
    console.log(<span style=color:#b44>&#34;Getting deployed Register contract...&#34;</span>)
    Register.deployed().then(<span style=color:#a2f;font-weight:700>function</span>(instance) {
        console.log(<span style=color:#b44>&#34;Register Judge contract...&#34;</span>);
        <span style=color:#a2f;font-weight:700>return</span> instance.contractRegister(<span style=color:#b44>&#34;Judger&#34;</span>, <span style=color:#b44>&#34;JC&#34;</span>, <span style=color:#b44>&#34;0xbffe4ff0cbd0a7590fb71966d1e6bb1a4c2359e0&#34;</span>, Judge.address);
    }).then(<span style=color:#a2f;font-weight:700>function</span>(error, result) {
        <span style=color:#a2f;font-weight:700>if</span>(<span style=color:#666>!</span>error) {
            console.log(<span style=color:#b44>&#34;Transaction:&#34;</span>, result.tx);
            console.log(<span style=color:#b44>&#34;Finished!&#34;</span>);
        }
        <span style=color:#a2f;font-weight:700>else</span>
            console.log(error);
    }).<span style=color:#a2f;font-weight:700>catch</span>(<span style=color:#a2f;font-weight:700>function</span>(e) {
        console.log(e);
        done();
    });
};
</code></pre></div><p>解锁node0账户，然后执行下列命令</p><div class=highlight><pre style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash>$ truffle <span style=color:#a2f>exec</span> JCRegister.js
</code></pre></div><p><code>truffle exec</code>执行错误，错误信息如下</p><div class=highlight><pre style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash>$ truffle <span style=color:#a2f>exec</span> JCRegister.js
Using network <span style=color:#b44>&#39;development&#39;</span>.

TypeError: fn is not a <span style=color:#a2f;font-weight:700>function</span>
    at Object.exec <span style=color:#666>(</span>/usr/local/lib/node_modules/truffle/build/webpack:/packages/require/require.js:124:1<span style=color:#666>)</span>
    at /usr/local/lib/node_modules/truffle/build/webpack:/packages/core/lib/commands/exec.js:89:1
    at processTicksAndRejections <span style=color:#666>(</span>internal/process/task_queues.js:93:5<span style=color:#666>)</span>
Truffle v5.1.5 <span style=color:#666>(</span>core: 5.1.5<span style=color:#666>)</span>
Node v12.14.0

</code></pre></div><h4 id=web3js><del>web3.js</del></h4><p>使用 web3.js，在用户根目录建立 web3 文件夹，本地安装 web3.js 模块</p><div class=highlight><pre style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash>$ <span style=color:#a2f>cd</span> ..
$ <span style=color:#a2f>pwd</span>
/home/shuzang
$ mkdir web3 <span style=color:#666>&amp;&amp;</span> <span style=color:#a2f>cd</span> web3
$ npm install web3
$ npm list --depth <span style=color:#666>0</span>
/home/shuzang/web3
└── web3@1.2.4
</code></pre></div><p>创建文件<code>1_Register_JC.js</code>用于注册判决合约，命名方式参考了 truffle 的命名方式文件内容如下，ABI 过长，本文以省略号代替。</p><div class=highlight><pre style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-js data-lang=js><span style=color:#a2f;font-weight:700>var</span> Web3 <span style=color:#666>=</span> require(<span style=color:#b44>&#39;web3&#39;</span>);
<span style=color:#a2f;font-weight:700>if</span>(<span style=color:#a2f;font-weight:700>typeof</span> web3 <span style=color:#666>!==</span><span style=color:#b44>&#39;undefined&#39;</span>){ <span style=color:#080;font-style:italic>//检查是否已有web3实例
</span><span style=color:#080;font-style:italic></span>    web3<span style=color:#666>=</span><span style=color:#a2f;font-weight:700>new</span> Web3(web3.currentProvider);
}<span style=color:#a2f;font-weight:700>else</span>{
    <span style=color:#080;font-style:italic>//否则就连接到给出节点
</span><span style=color:#080;font-style:italic></span>    web3<span style=color:#666>=</span><span style=color:#a2f;font-weight:700>new</span> Web3();
    web3.setProvider(<span style=color:#a2f;font-weight:700>new</span> Web3.providers.WebsocketProvider(<span style=color:#b44>&#34;ws://localhost:8545&#34;</span>));
}

<span style=color:#a2f;font-weight:700>var</span> rcAbi <span style=color:#666>=</span> [...]

web3.eth.getBlock(<span style=color:#666>0</span>, <span style=color:#a2f;font-weight:700>function</span>(error, result){
	<span style=color:#a2f;font-weight:700>if</span>(<span style=color:#666>!</span>error)
		console.log(<span style=color:#b44>&#34;connection succeed&#34;</span>);
	<span style=color:#a2f;font-weight:700>else</span>
		console.log(<span style=color:#b44>&#34;something wrong, connection failed&#34;</span>);
});


<span style=color:#a2f;font-weight:700>var</span> rcAddress <span style=color:#666>=</span> <span style=color:#b44>&#34;0x8980FC2bBD25958d0c72F5ba5fa3e5faF1A48c05&#34;</span>;
<span style=color:#a2f;font-weight:700>var</span> jcAddress<span style=color:#666>=</span> <span style=color:#b44>&#34;0x2C2Fb0DD2440e72318Fb018f923F78Ff86541D08&#34;</span>;

<span style=color:#a2f;font-weight:700>var</span> register <span style=color:#666>=</span> <span style=color:#a2f;font-weight:700>new</span> web3.eth.Contract(rcAbi);
register.options.address<span style=color:#666>=</span>rcAddress;

register.methods.contractRegister(<span style=color:#b44>&#34;Judger&#34;</span>, <span style=color:#b44>&#34;JC&#34;</span>, <span style=color:#b44>&#34;0xbffe4ff0cbd0a7590fb71966d1e6bb1a4c2359e0&#34;</span>, jcAddress).send({
	from<span style=color:#666>:</span> <span style=color:#b44>&#34;0xbffe4ff0cbd0a7590fb71966d1e6bb1a4c2359e0&#34;</span>,
	gas<span style=color:#666>:</span> <span style=color:#666>10000000</span>
}, <span style=color:#a2f;font-weight:700>function</span> (error, result){
	<span style=color:#a2f;font-weight:700>if</span>(<span style=color:#666>!</span>error){
		console.log(<span style=color:#b44>&#39;Transaction: &#39;</span> <span style=color:#666>+</span> result);
		console.log(<span style=color:#b44>&#39;Finished!&#39;</span>);
	}
	<span style=color:#a2f;font-weight:700>else</span>
		console.log(error);
 })

 register.methods.getContractAddr(<span style=color:#b44>&#34;Judger&#34;</span>).call({
	from<span style=color:#666>:</span> <span style=color:#b44>&#34;0xbffe4ff0cbd0a7590fb71966d1e6bb1a4c2359e0&#34;</span>,
	gas<span style=color:#666>:</span> <span style=color:#666>10000000</span>
}, <span style=color:#a2f;font-weight:700>function</span> (error, result){
	<span style=color:#a2f;font-weight:700>if</span>(<span style=color:#666>!</span>error){
        console.log(<span style=color:#b44>&#39;Judge contract address:&#39;</span> <span style=color:#666>+</span> result);
	}
	<span style=color:#a2f;font-weight:700>else</span>
		console.log(error);
 })
</code></pre></div><p>web3.js执行合约交易不成功，全部陷在交易池了</p><div class=highlight><pre style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-js data-lang=js><span style=color:#666>&gt;</span> txpool.status
{
  pending<span style=color:#666>:</span> <span style=color:#666>5</span>,
  queued<span style=color:#666>:</span> <span style=color:#666>0</span>
}
</code></pre></div><p>日志记录里提示</p><div class=highlight><pre style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash>VM returned with error                   <span style=color:#b8860b>err</span><span style=color:#666>=</span><span style=color:#b44>&#34;evm: execution reverted&#34;</span>
</code></pre></div><h4 id=truffle-console>truffle console</h4><p>truffle的文档里提到与已部署的合约交互可以使用truffle console，故尝试</p><p>首先注册判决合约，需要在node0中进行，进入<code>development</code>网络</p><div class=highlight><pre style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash>$ truffle console
</code></pre></div><p>命令执行完毕后进入<code>truffle console</code>控制台，注册合约并查询合约地址进行验证</p><div class=highlight><pre style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-js data-lang=js>truffle(development)<span style=color:#666>&gt;</span> Register.deployed().then(<span style=color:#a2f;font-weight:700>function</span>(instance) {instance.contractRegister(<span style=color:#b44>&#34;Judger&#34;</span>, <span style=color:#b44>&#34;JC&#34;</span>, <span style=color:#b44>&#34;0xbffe4ff0cbd0a7590fb71966d1e6bb1a4c2359e0&#34;</span>, Judge.address);})
<span style=color:#a2f;font-weight:700>undefined</span>
truffle(development)<span style=color:#666>&gt;</span> Register.deployed().then(<span style=color:#a2f;font-weight:700>function</span>(instance) {<span style=color:#a2f;font-weight:700>return</span> instance.getContractAddr(<span style=color:#b44>&#34;Judger&#34;</span>);})
<span style=color:#b44>&#39;0x2C2Fb0DD2440e72318Fb018f923F78Ff86541D08&#39;</span>
</code></pre></div><p>退出重新执行<code>truffle console</code>命令，进入<code>lightnode2</code>网络</p><div class=highlight><pre style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash>truffle<span style=color:#666>(</span>development<span style=color:#666>)</span>&gt; .exit
$ truffle console --network lightnode2
</code></pre></div><p>进入<code>lightnode2</code>的<code>truffle console</code>控制台，注册设备相关属性，然后查询属性进行验证</p><div class=highlight><pre style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-js data-lang=js>truffle(lightnode2)<span style=color:#666>&gt;</span> <span style=color:#a2f;font-weight:700>let</span> instance <span style=color:#666>=</span> await Register.deployed()
<span style=color:#a2f;font-weight:700>undefined</span>
truffle(lightnode2)<span style=color:#666>&gt;</span> instance.subjectRegister(<span style=color:#b44>&#34;0x016b71d115f1da36de58d2b78369fd3228bef3dd&#34;</span>, <span style=color:#b44>&#34;0xa31d40508da63fb00d7e2f4db57c3774384aa299&#34;</span>, <span style=color:#b44>&#34;thermostat&#34;</span>, <span style=color:#b44>&#34;subject&#34;</span>)
...
truffle(lightnode2)<span style=color:#666>&gt;</span> instance.getAttribute(<span style=color:#b44>&#34;0x016b71d115f1da36de58d2b78369fd3228bef3dd&#34;</span>, <span style=color:#b44>&#34;deviceType&#34;</span>)
<span style=color:#b44>&#39;thermostat&#39;</span>
truffle(lightnode2)<span style=color:#666>&gt;</span> instance.getAttribute(<span style=color:#b44>&#34;0x016b71d115f1da36de58d2b78369fd3228bef3dd&#34;</span>, <span style=color:#b44>&#34;deviceRole&#34;</span>)
<span style=color:#b44>&#39;subject&#39;</span>
</code></pre></div><p>退出<code>lightnode2</code>的控制台，进入<code>lightnode1</code>的控制台</p><div class=highlight><pre style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash>truffle<span style=color:#666>(</span>lightnode2<span style=color:#666>)</span>&gt; .exit
$ truffle console --network lightnode1
</code></pre></div><p>首先在RC中注册ACC</p><div class=highlight><pre style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-js data-lang=js>truffle(lightnode1)<span style=color:#666>&gt;</span> Register.deployed().then(<span style=color:#a2f;font-weight:700>function</span>(instance) {instance.contractRegister(<span style=color:#b44>&#34;Temperature_Sensor1&#34;</span>, <span style=color:#b44>&#34;ACC&#34;</span>, <span style=color:#b44>&#34;0x9a4aa696f85c6bf96733cc5385ccaf2b7ee13f17&#34;</span>, AccessControl.address);})
<span style=color:#a2f;font-weight:700>undefined</span>
truffle(lightnode1)<span style=color:#666>&gt;</span> Register.deployed().then(<span style=color:#a2f;font-weight:700>function</span>(instance) {<span style=color:#a2f;font-weight:700>return</span> instance.getContractAddr(<span style=color:#b44>&#34;Temperature_Sensor1&#34;</span>);})
<span style=color:#b44>&#39;0x05455fa63e5a7cb6575D75c99855cF3A1Adc72b1&#39;</span>
</code></pre></div><p>然后在ACC中注册资源属性，并查询属性进行验证</p><div class=highlight><pre style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-js data-lang=js>truffle(lightnode1)<span style=color:#666>&gt;</span> <span style=color:#a2f;font-weight:700>let</span> instance <span style=color:#666>=</span> await AccessControl.deployed()
<span style=color:#a2f;font-weight:700>undefined</span>
truffle(lightnode1)<span style=color:#666>&gt;</span> instance.resourceAttrAdd(<span style=color:#b44>&#34;data&#34;</span>, <span style=color:#b44>&#34;currentTemperature&#34;</span>, <span style=color:#b44>&#34;23&#34;</span>)
truffle(lightnode1)<span style=color:#666>&gt;</span> instance.getResourceAttr(<span style=color:#b44>&#34;data&#34;</span>, <span style=color:#b44>&#34;currentTemperature&#34;</span>)
<span style=color:#b44>&#39;23&#39;</span>
</code></pre></div><p>接下来针对已注册的属性，在ACC中设置访问控制策略，并查询策略进行验证</p><div class=highlight><pre style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-js data-lang=js>truffle(lightnode1)<span style=color:#666>&gt;</span> instance.policyAdd(<span style=color:#b44>&#34;data&#34;</span>, <span style=color:#b44>&#34;read&#34;</span>, <span style=color:#b44>&#34;subject&#34;</span>, <span style=color:#b44>&#34;deviceType&#34;</span>, <span style=color:#b44>&#34;=&#34;</span>, <span style=color:#b44>&#34;thermostat&#34;</span>)
truffle(lightnode1)<span style=color:#666>&gt;</span> instance.getPolicy(<span style=color:#b44>&#34;data&#34;</span>, <span style=color:#b44>&#34;read&#34;</span>, <span style=color:#b44>&#34;deviceType&#34;</span>)
Result {
  <span style=color:#b44>&#39;0&#39;</span><span style=color:#666>:</span> <span style=color:#b44>&#39;subject&#39;</span>,
  <span style=color:#b44>&#39;1&#39;</span><span style=color:#666>:</span> <span style=color:#b44>&#39;deviceType&#39;</span>,
  <span style=color:#b44>&#39;2&#39;</span><span style=color:#666>:</span> <span style=color:#b44>&#39;=&#39;</span>,
  <span style=color:#b44>&#39;3&#39;</span><span style=color:#666>:</span> <span style=color:#b44>&#39;thermostat&#39;</span>,
  _attrOwner<span style=color:#666>:</span> <span style=color:#b44>&#39;subject&#39;</span>,
  _attrName_<span style=color:#666>:</span> <span style=color:#b44>&#39;deviceType&#39;</span>,
  _operator<span style=color:#666>:</span> <span style=color:#b44>&#39;=&#39;</span>,
  _attrValue<span style=color:#666>:</span> <span style=color:#b44>&#39;thermostat&#39;</span>
}
</code></pre></div><p>最后发起访问控制请求和监听依然使用web3.js完成，切换到web3目录下，首先新建<code>test.js</code>测试是否可使用，测试脚本内容如下</p><div class=highlight><pre style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-js data-lang=js><span style=color:#a2f;font-weight:700>var</span> Web3 <span style=color:#666>=</span> require(<span style=color:#b44>&#39;web3&#39;</span>);

<span style=color:#a2f;font-weight:700>if</span>(<span style=color:#a2f;font-weight:700>typeof</span> web3 <span style=color:#666>!==</span><span style=color:#b44>&#39;undefined&#39;</span>){ <span style=color:#080;font-style:italic>//检查是否已有web3实例
</span><span style=color:#080;font-style:italic></span>    web3<span style=color:#666>=</span><span style=color:#a2f;font-weight:700>new</span> Web3(web3.currentProvider);
}<span style=color:#a2f;font-weight:700>else</span>{
    <span style=color:#080;font-style:italic>//否则就连接到给出节点
</span><span style=color:#080;font-style:italic></span>    web3<span style=color:#666>=</span><span style=color:#a2f;font-weight:700>new</span> Web3();
    web3.setProvider(<span style=color:#a2f;font-weight:700>new</span> Web3.providers.WebsocketProvider(<span style=color:#b44>&#34;ws://localhost:8545&#34;</span>));
};

<span style=color:#a2f;font-weight:700>var</span> connect <span style=color:#666>=</span> <span style=color:#a2f;font-weight:700>function</span>() {
    web3.eth.getBlock(<span style=color:#666>0</span>, <span style=color:#a2f;font-weight:700>function</span>(error, result){
        <span style=color:#a2f;font-weight:700>if</span>(<span style=color:#666>!</span>error)
            console.log(<span style=color:#b44>&#34;connection succeed&#34;</span>);
        <span style=color:#a2f;font-weight:700>else</span>
            console.log(<span style=color:#b44>&#34;something wrong, connection failed&#34;</span>);
    });
}


<span style=color:#a2f;font-weight:700>var</span> getAccount <span style=color:#666>=</span> async <span style=color:#a2f;font-weight:700>function</span>() {
    await connect();
    <span style=color:#a2f;font-weight:700>var</span> account0;
    web3.eth.getAccounts(<span style=color:#a2f;font-weight:700>function</span>(error, result){
        <span style=color:#a2f;font-weight:700>if</span>(<span style=color:#666>!</span>error){
            account0<span style=color:#666>=</span>result[<span style=color:#666>0</span>];
            <span style=color:#080;font-style:italic>//console.log(account0);
</span><span style=color:#080;font-style:italic></span>            console.log(<span style=color:#b44>&#34;accounts:&#34;</span><span style=color:#666>+</span>result);
        }
        <span style=color:#a2f;font-weight:700>else</span>{
            console.log(<span style=color:#b44>&#34;failed to get Accoutns&#34;</span>);
        }
    });
}


getAccount().then(<span style=color:#a2f;font-weight:700>function</span>() {
    web3.eth.getBalance(<span style=color:#b44>&#34;0xbffe4ff0cbd0a7590fb71966d1e6bb1a4c2359e0&#34;</span>).then(<span style=color:#a2f;font-weight:700>function</span>(balance) {
        console.log(<span style=color:#b44>&#39;balance:&#39;</span>,balance);
        console.log(<span style=color:#b44>&#34;test passed!&#34;</span>);
    })
})
</code></pre></div><p>测试结果如下，说明没有问题</p><div class=highlight><pre style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash>$ node test.js
connection succeed
accounts:0xbfFe4ff0cBd0A7590Fb71966D1E6bb1a4c2359e0
balance: <span style=color:#666>99999999999999999999999999999998000000000000000000</span>
<span style=color:#a2f>test</span> passed！
</code></pre></div><p>在 web3 目录下新建<code>requester.js</code>文件和<code>monitor.js</code>文件，前者用来发起访问控制请求，后者用来监听访问控制触发的事件</p><p><code>requester.js</code>的内容如下，通过 websocket 连接 lightnode2，发起访问控制请求</p><div class=highlight><pre style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-js data-lang=js><span style=color:#a2f;font-weight:700>var</span> Web3 <span style=color:#666>=</span> require(<span style=color:#b44>&#39;web3&#39;</span>);
<span style=color:#a2f;font-weight:700>var</span> readline <span style=color:#666>=</span> require(<span style=color:#b44>&#39;readline&#39;</span>);
<span style=color:#a2f;font-weight:700>var</span> web3 <span style=color:#666>=</span> <span style=color:#a2f;font-weight:700>new</span> Web3(Web3.givenProvider <span style=color:#666>||</span> <span style=color:#b44>&#34;ws://192.168.191.4:8545&#34;</span>);

<span style=color:#a2f;font-weight:700>var</span> accAbi <span style=color:#666>=</span> [...];

<span style=color:#a2f;font-weight:700>var</span> accAddr <span style=color:#666>=</span> <span style=color:#b44>&#34;0xb29094a4DE9c2E22b598b39fE38860b9117340A6&#34;</span>
<span style=color:#a2f;font-weight:700>var</span> myACC <span style=color:#666>=</span> <span style=color:#a2f;font-weight:700>new</span> web3.eth.Contract(accAbi, accAddr);


<span style=color:#a2f;font-weight:700>var</span> previousTxHash <span style=color:#666>=</span> <span style=color:#666>0</span>;
<span style=color:#a2f;font-weight:700>var</span> currentTxHash <span style=color:#666>=</span> <span style=color:#666>0</span>;

<span style=color:#a2f;font-weight:700>var</span> rl <span style=color:#666>=</span> readline.createInterface({
	input<span style=color:#666>:</span> process.stdin,
	output<span style=color:#666>:</span> process.stdout,
	prompt<span style=color:#666>:</span> <span style=color:#b44>&#39;Send access request?(y/n)&#39;</span>
});

rl.prompt();
rl.on(<span style=color:#b44>&#39;line&#39;</span>,(answer) =&gt; {
	<span style=color:#a2f;font-weight:700>if</span>(<span style=color:#b44>&#39;y&#39;</span> <span style=color:#666>==</span> answer) {
	myACC.methods.accessControl(<span style=color:#b44>&#34;data&#34;</span>, <span style=color:#b44>&#34;read&#34;</span>).send({
			from<span style=color:#666>:</span> <span style=color:#b44>&#34;0xbd93271c5d2ccacdc307d1825614d5557ad6e0fd&#34;</span>,
			gas<span style=color:#666>:</span> <span style=color:#666>10000000</span>,
			gasPrice<span style=color:#666>:</span> <span style=color:#666>0</span>
		},<span style=color:#a2f;font-weight:700>function</span>(error,result){
			<span style=color:#a2f;font-weight:700>if</span>(<span style=color:#666>!</span>error){
				currentTxHash <span style=color:#666>=</span> result
				console.log(<span style=color:#b44>&#34;currentTxHash: &#34;</span>, result)
			}
		})

	myACC.events.ReturnAccessResult({
			fromBlock<span style=color:#666>:</span> <span style=color:#666>0</span>
		}, <span style=color:#a2f;font-weight:700>function</span>(error, result){
		<span style=color:#a2f;font-weight:700>if</span>(<span style=color:#666>!</span>error) {
			<span style=color:#a2f;font-weight:700>if</span>(previousTxHash <span style=color:#666>!=</span> result.transactionHash <span style=color:#666>&amp;&amp;</span> currentTxHash <span style=color:#666>==</span> result.transactionHash) {
				console.log(<span style=color:#b44>&#34;Contract: &#34;</span><span style=color:#666>+</span>result.address);
				console.log(<span style=color:#b44>&#34;Block Number: &#34;</span><span style=color:#666>+</span>result.blockNumber);
				console.log(<span style=color:#b44>&#34;Tx Hash: &#34;</span><span style=color:#666>+</span>result.transactionHash);
				console.log(<span style=color:#b44>&#34;Block Hash: &#34;</span><span style=color:#666>+</span>result.blockHash);
				console.log(<span style=color:#b44>&#34;Time: &#34;</span><span style=color:#666>+</span>result.returnValues._time);
				console.log(<span style=color:#b44>&#34;Message: &#34;</span><span style=color:#666>+</span>result.returnValues._errmsg);
				console.log(<span style=color:#b44>&#34;Result: &#34;</span><span style=color:#666>+</span>result.returnValues._result);
				<span style=color:#a2f;font-weight:700>if</span> (result.returnValues._penalty <span style=color:#666>&gt;</span> <span style=color:#666>0</span>) {
					console.log(<span style=color:#b44>&#34;Requests are blocked for &#34;</span> <span style=color:#666>+</span> result.returnValues._penalty <span style=color:#666>+</span><span style=color:#b44>&#34;seconds!&#34;</span>)
				}
				console.log(<span style=color:#b44>&#39;\n&#39;</span>);
				previousTxHash <span style=color:#666>=</span> result.transactionHash;
				rl.prompt();
			}
		}
	})
	}
	<span style=color:#a2f;font-weight:700>else</span>{
	console.log(<span style=color:#b44>&#34;access request doesn&#39;t send!&#34;</span>)
	rl.prompt();
	}
}).on(<span style=color:#b44>&#39;close&#39;</span>,() =&gt;{
	console.log(<span style=color:#b44>&#39;All actions had executed!&#39;</span>);
	process.exit(<span style=color:#666>0</span>);
});
</code></pre></div><p><code>monitor.js</code>的内容如下，由 lightnode1 发起，用于监听返回的事件</p><div class=highlight><pre style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-js data-lang=js><span style=color:#a2f;font-weight:700>var</span> Web3 <span style=color:#666>=</span> require(<span style=color:#b44>&#39;web3&#39;</span>);
<span style=color:#a2f;font-weight:700>var</span> web3 <span style=color:#666>=</span> <span style=color:#a2f;font-weight:700>new</span> Web3(Web3.givenProvider <span style=color:#666>||</span> <span style=color:#b44>&#34;ws://192.168.191.3:8545&#34;</span>);

<span style=color:#a2f;font-weight:700>var</span> accAbi <span style=color:#666>=</span> [...];
<span style=color:#a2f;font-weight:700>var</span> accAddr <span style=color:#666>=</span> <span style=color:#b44>&#34;0xb29094a4DE9c2E22b598b39fE38860b9117340A6&#34;</span>;
<span style=color:#a2f;font-weight:700>var</span> myACC <span style=color:#666>=</span> <span style=color:#a2f;font-weight:700>new</span> web3.eth.Contract(accAbi, accAddr);

myACC.events.ReturnAccessResult({
	fromBlock<span style=color:#666>:</span> <span style=color:#666>0</span>
}, <span style=color:#a2f;font-weight:700>function</span>(error, result){
		<span style=color:#a2f;font-weight:700>if</span>(<span style=color:#666>!</span>error) {
			console.log(<span style=color:#b44>&#34;Contract: &#34;</span><span style=color:#666>+</span>result.address);
			console.log(<span style=color:#b44>&#34;Block Number: &#34;</span><span style=color:#666>+</span>result.blockNumber);
			console.log(<span style=color:#b44>&#34;Tx Hash: &#34;</span><span style=color:#666>+</span>result.transactionHash);
			console.log(<span style=color:#b44>&#34;Block Hash: &#34;</span><span style=color:#666>+</span>result.blockHash);
			console.log(<span style=color:#b44>&#34;Time: &#34;</span><span style=color:#666>+</span>result.returnValues._time);
			console.log(<span style=color:#b44>&#34;Message: &#34;</span><span style=color:#666>+</span>result.returnValues._errmsg);
			console.log(<span style=color:#b44>&#34;Result: &#34;</span><span style=color:#666>+</span>result.returnValues._result);
			<span style=color:#a2f;font-weight:700>if</span> (result.returnValues._penalty <span style=color:#666>&gt;</span> <span style=color:#666>0</span>) {
				console.log(<span style=color:#b44>&#34;Requests are blocked for &#34;</span> <span style=color:#666>+</span> result.returnValues._penalty <span style=color:#666>+</span><span style=color:#b44>&#34;seconds!&#34;</span>)
			}
			console.log(<span style=color:#b44>&#39;\n&#39;</span>);
		}
})
</code></pre></div><p>实验结果如下</p><p><img src=https://picped-1301226557.cos.ap-beijing.myqcloud.com/YJS_20200115_81cdmj.png alt="request access authorized"></p><p><img src=https://picped-1301226557.cos.ap-beijing.myqcloud.com/YJS_20200115_81c6pT.png alt="monitor access authorized"></p><p><img src=https://picped-1301226557.cos.ap-beijing.myqcloud.com/YJS_20200115_81gC38.png alt="request blocked"></p><p><img src=https://picped-1301226557.cos.ap-beijing.myqcloud.com/YJS_20200115_81g8b9.png alt="monitor request blocked"></p><h3 id=36-错误测试>3.6 错误测试</h3><p>之前的实验验证的是访问权限被授予的情况，现在测试被拒绝的情况</p><p>在 lightnode2 建立新的IoT设备账户，这次代表摄像头(Camera)，</p><div class=highlight><pre style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash>&gt; personal.newAccount<span style=color:#666>(</span><span style=color:#666>)</span>
Passphrase: 
Repeat passphrase: 
<span style=color:#b44>&#34;0x42b97b26ed5f53693bcc9b58ad8c724718ea0a15&#34;</span>
&gt; personal.listAccounts
<span style=color:#666>[</span><span style=color:#b44>&#34;0xa31d40508da63fb00d7e2f4db57c3774384aa299&#34;</span>, <span style=color:#b44>&#34;0x016b71d115f1da36de58d2b78369fd3228bef3dd&#34;</span>, <span style=color:#b44>&#34;0x42b97b26ed5f53693bcc9b58ad8c724718ea0a15&#34;</span><span style=color:#666>]</span>
&gt; personal.unlockAccount<span style=color:#666>(</span>eth.accounts<span style=color:#666>[</span>0<span style=color:#666>]</span><span style=color:#666>)</span>
Unlock account 0xa31d40508da63fb00d7e2f4db57c3774384aa299
Passphrase: 
<span style=color:#a2f>true</span>
&gt; eth.sendTransaction<span style=color:#666>(</span><span style=color:#666>{</span>from:eth.accounts<span style=color:#666>[</span>0<span style=color:#666>]</span>,to:eth.accounts<span style=color:#666>[</span>2<span style=color:#666>]</span>,value:1*1e7<span style=color:#666>}</span><span style=color:#666>)</span>
<span style=color:#b44>&#34;0x9f36de89d44db23e63e4fa0d3135d1c17e800cca73f0661ae276f20c0e3d1902&#34;</span>
&gt; eth.getBalance<span style=color:#666>(</span>eth.accounts<span style=color:#666>[</span>2<span style=color:#666>]</span><span style=color:#666>)</span>
<span style=color:#666>10000000</span>
</code></pre></div><p>修改<code>truffle-config.js</code>文件中 lightnode2 网络的执行账户为新建立的账户</p><div class=highlight><pre style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-js data-lang=js>...
lightnode2<span style=color:#666>:</span> {
  host<span style=color:#666>:</span> <span style=color:#b44>&#34;192.168.191.4&#34;</span>,  
  port<span style=color:#666>:</span> <span style=color:#666>22000</span>,            <span style=color:#080;font-style:italic>// Standard Ethereum port (default: none)
</span><span style=color:#080;font-style:italic></span>  network_id<span style=color:#666>:</span> <span style=color:#b44>&#34;10&#34;</span>,       
  gasPrice<span style=color:#666>:</span> <span style=color:#666>0</span>,
  gas<span style=color:#666>:</span> <span style=color:#666>10000000</span>,
  type<span style=color:#666>:</span> <span style=color:#b44>&#34;quorum&#34;</span>,
  from<span style=color:#666>:</span> <span style=color:#b44>&#34;0x42b97b26ed5f53693bcc9b58ad8c724718ea0a15&#34;</span>,
 ...
</code></pre></div><p>进入<code>lightnode2</code>的 truffle console</p><div class=highlight><pre style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash>$ <span style=color:#a2f>cd</span> AC
$ truffle console --network lightnode2
</code></pre></div><p>注册新设备的属性</p><div class=highlight><pre style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-js data-lang=js>truffle(lightnode2)<span style=color:#666>&gt;</span> Register.deployed().then(<span style=color:#a2f;font-weight:700>function</span>(instance) {instance.subjectRegister(<span style=color:#b44>&#34;0x42b97b26ed5f53693bcc9b58ad8c724718ea0a15&#34;</span>,<span style=color:#b44>&#34;0xa31d40508da63fb00d7e2f4db57c3774384aa299&#34;</span>, <span style=color:#b44>&#34;camera&#34;</span>, <span style=color:#b44>&#34;subject&#34;</span>);})
<span style=color:#a2f;font-weight:700>undefined</span>
truffle(lightnode2)<span style=color:#666>&gt;</span> Register.deployed().then(<span style=color:#a2f;font-weight:700>function</span>(instance) {instance.getAttribute(<span style=color:#b44>&#34;0x42b97b26ed5f53693bcc9b58ad8c724718ea0a15&#34;</span>,<span style=color:#b44>&#34;deviceType&#34;</span>);})
<span style=color:#b44>&#39;camera&#39;</span>
truffle(lightnode2)<span style=color:#666>&gt;</span> Register.deployed().then(<span style=color:#a2f;font-weight:700>function</span>(instance) {instance.getAttribute(<span style=color:#b44>&#34;0x42b97b26ed5f53693bcc9b58ad8c724718ea0a15&#34;</span>,<span style=color:#b44>&#34;deviceRole&#34;</span>);})
<span style=color:#b44>&#39;subject&#39;</span>
</code></pre></div><p>建立<code>requester2.js</code>，内容和<code>requester.js</code>相似，只是发起访问控制的是<code>lightnode2</code>新建立的<code>camera</code>设备账户，也就是说与requester.js的不同仅在于发起访问控制的账户</p><p>错误测试的结果如下</p><p><img src=https://picped-1301226557.cos.ap-beijing.myqcloud.com/YJS_20200115_81gQvF.png alt="request static check failed"></p><p><img src=https://picped-1301226557.cos.ap-beijing.myqcloud.com/YJS_20200115_81gK3T.png alt="monitor static check failed"></p><h3 id=37-步骤总结>3.7 步骤总结</h3><p>总结一下本篇中需要做的事情</p><ol><li>node0 部署RC，获取RC合约地址</li><li>node0 部署JC，传入参数base=2、interval=3，获取JC的合约地址</li><li>JC 合约在RC中注册</li><li>node0 分别转给lightnode1和lightnode2 1 ether</li><li>lightnode1 新建IoT设备账户，从第一个账户向该账户转入1000 0000wei</li><li>lightnode2 新建两个IoT设备账户，从第一个账户分别向这两个账户转入1000 0000wei</li><li>lightnode2 的两个IoT设备账户在RC中注册设备属性(事实上所有节点都应注册设备属性，这里是因为实验只需要它们两个发起访问控制)</li><li>lightnode1 的IoT设备账户部署ACC，传入RC和JC的合约地址，获取ACC的合约地址</li><li>lightnode1 在RC中注册ACC</li><li>lightnode1 在ACC中注册资源属性，设置访问控制策略</li><li>lingtnode2 的两个IoT设备通过调用ACC向lightnode1的IoT设备发起访问控制</li></ol></div><footer class=post-footer><div class=post-tags><a href=/tags/%e7%a7%91%e7%a0%94%e8%ae%b0%e5%bd%95 rel=tag title=科研记录>#科研记录#</a></div><div class=addthis_inline_share_toolbox></div><div class=post-nav><div class=article-copyright><div class=article-copyright-info><p><span>声明：</span>研究记录11-新访问控制方案的实现与测试</p><p><span>链接：</span>https://shuzang.github.io/2020/01/optimize-the-implementation-and-testing-of-the-system/</p><p><span>作者：</span>书藏</p><p><span>声明： </span>本博客文章除特别声明外，均采用 <a href=https://creativecommons.org/licenses/by-nc-sa/4.0/ target=_blank style=text-decoration:underline>CC BY-NC-SA 3.0</a>许可协议，转载请注明出处！</p></div></div><div class=clear></div></div><div class=reward-qr-info><div>创作实属不易，如有帮助，那就打赏博主些许茶钱吧 ^_^</div><button id=rewardButton disable=enable onclick="var qr=document.getElementById('QR');if(qr.style.display==='none'){qr.style.display='block';}else{qr.style.display='none'}">
<span>赏</span></button><div id=QR style=display:none><div id=wechat style=display:inline-block><img id=wechat_qr src=/img/wechat-pay.png alt="WeChat Pay"><p>微信打赏</p></div><div id=alipay style=display:inline-block><img id=alipay_qr src=/img/ali-pay.png alt=Alipay><p>支付宝打赏</p></div></div></div><div class=post-nav><div class="post-nav-next post-nav-item"><a href=https://shuzang.github.io/2020/01/life-weekly-3/ rel=next title="书藏的生活周刊第 3 期 (20200117)"><i class="fa fa-chevron-left"></i>书藏的生活周刊第 3 期 (20200117)</a></div><div class="post-nav-prev post-nav-item"><a href=https://shuzang.github.io/2020/01/life-weekly-2/ rel=prev title="书藏的生活周刊第 2 期 (20200110)">书藏的生活周刊第 2 期 (20200110)
<i class="fa fa-chevron-right"></i></a></div></div><div id=wcomments></div></footer></article></section></div></div><div class=sidebar-toggle><div class=sidebar-toggle-line-wrap><span class="sidebar-toggle-line sidebar-toggle-line-first"></span><span class="sidebar-toggle-line sidebar-toggle-line-middle"></span><span class="sidebar-toggle-line sidebar-toggle-line-last"></span></div></div><aside id=sidebar class=sidebar><div class=sidebar-inner><ul class="sidebar-nav motion-element"><li class="sidebar-nav-toc sidebar-nav-active" data-target=post-toc-wrap>文章目录</li><li class=sidebar-nav-overview data-target=site-overview>站点概览</li></ul><section class="site-overview sidebar-panel"><div class="site-author motion-element" itemprop=author itemscope itemtype=http://schema.org/Person><img class=site-author-image itemprop=image src=/images/avatar.png alt=书藏><p class=site-author-name itemprop=name>书藏</p><p class="site-description motion-element" itemprop=description></p></div><nav class="site-state motion-element"><div class="site-state-item site-state-posts"><a href=/post/><span class=site-state-item-count>334</span>
<span class=site-state-item-name>日志</span></a></div><div class="site-state-item site-state-categories"><a href=/categories/><span class=site-state-item-count>7</span>
<span class=site-state-item-name>分类</span></a></div><div class="site-state-item site-state-tags"><a href=/tags/><span class=site-state-item-count>23</span>
<span class=site-state-item-name>标签</span></a></div></nav><div class="links-of-author motion-element"><span class=links-of-author-item><a href=https://github.com/shuzang/ target=_blank title=GitHub><i class="fa fa-fw fa-github"></i>GitHub</a></span>
<span class=links-of-author-item><a href="https://www.douban.com/people/159916010/?_i=9150521DKS5bK1" target=_blank title=豆瓣><i class="fa fa-fw fa-film"></i>豆瓣</a></span></div><div class="tagcloud-of-blogroll motion-element tagcloud-of-blogroll-inline"><div class=tagcloud-of-blogroll-title><i class="fa fa-fw fa-tags"></i>标签云</div><ul class=tagcloud-of-blogroll-list><li class=tagcloud-of-blogroll-item><a href=/tags/%E8%AE%BA%E6%96%87%E7%AC%94%E8%AE%B0>论文笔记</a></li><li class=tagcloud-of-blogroll-item><a href=/tags/%E4%B9%A6%E8%97%8F%E7%9A%84%E7%94%9F%E6%B4%BB%E5%91%A8%E5%88%8A>书藏的生活周刊</a></li><li class=tagcloud-of-blogroll-item><a href=/tags/%E7%A7%91%E7%A0%94%E8%AE%B0%E5%BD%95>科研记录</a></li><li class=tagcloud-of-blogroll-item><a href=/tags/go%E8%AF%AD%E6%B3%95>Go语法</a></li><li class=tagcloud-of-blogroll-item><a href=/tags/%E8%AE%A1%E7%AE%97%E6%9C%BA%E5%9F%BA%E7%A1%80>计算机基础</a></li><li class=tagcloud-of-blogroll-item><a href=/tags/%E6%9D%82%E8%B0%88>杂谈</a></li><li class=tagcloud-of-blogroll-item><a href=/tags/%E5%8C%BA%E5%9D%97%E9%93%BE>区块链</a></li><li class=tagcloud-of-blogroll-item><a href=/tags/%E6%95%B0%E6%8D%AE%E7%BB%93%E6%9E%84%E4%B8%8E%E7%AE%97%E6%B3%95>数据结构与算法</a></li><li class=tagcloud-of-blogroll-item><a href=/tags/%E7%94%9F%E6%B4%BB%E6%8A%80%E8%83%BD>生活技能</a></li><li class=tagcloud-of-blogroll-item><a href=/tags/go%E5%AE%9E%E6%88%98>Go实战</a></li></ul></div></section><section class="post-toc-wrap motion-element sidebar-panel sidebar-panel-active"><div class=post-toc><div class=post-toc-content><nav id=TableOfContents><ul><li><a href=#1-智能合约>1. 智能合约</a><ul><li><a href=#11-gas消耗统计>1.1 Gas消耗统计</a></li><li><a href=#12-合约功能说明>1.2 合约功能说明</a></li></ul></li><li><a href=#2-审计>2. 审计</a><ul><li><a href=#21-工具选取>2.1 工具选取</a></li><li><a href=#22-审计>2.2 审计</a></li><li><a href=#23-审计结果>2.3 审计结果</a></li></ul></li><li><a href=#3-系统测试>3. 系统测试</a><ul><li><a href=#31-账户设置>3.1 账户设置</a></li><li><a href=#32-安装truffle>3.2 安装Truffle</a></li><li><a href=#33-创建项目和基本配置>3.3 创建项目和基本配置</a></li><li><a href=#34-部署>3.4 部署</a></li><li><a href=#35-合约交互>3.5 合约交互</a></li><li><a href=#36-错误测试>3.6 错误测试</a></li><li><a href=#37-步骤总结>3.7 步骤总结</a></li></ul></li></ul></nav></div></div></section></div></aside></div></main><footer id=footer class=footer><div class=footer-inner><div class=copyright><span class=copyright-year>&copy; 2018 - 2022</span>
<span class=with-love><i class="fa fa-heart"></i></span><span class=copyright-author>书藏的博客</span></div><div class=powered-info><span class=powered-by>Powered by - <a class=powered-link href=//gohugo.io target=_blank title=hugo>Hugo v0.63.2</a></span>
<span class=separator-line>/</span>
<span class=theme-info>Theme by - <a class=powered-link href=//github.com/elkan1788/hugo-theme-next target=_blank>NexT</a></span></div><div class=vistor-info><script async src=//busuanzi.ibruce.info/busuanzi/2.3/busuanzi.pure.mini.js></script><span class=site-uv><i class="fa fa-user"></i><span class=busuanzi-value id=busuanzi_value_site_uv></span></span><span class=separator-line>/</span>
<span class=site-pv><i class="fa fa-eye"></i><span class=busuanzi-value id=busuanzi_value_site_pv></span></span></div></div></footer><div class=back-to-top><i class="fa fa-arrow-up"></i><span id=scrollpercent><span>0</span>%</span></div></div><script type=text/javascript src=//cdn.bootcdn.net/ajax/libs/jquery/2.1.4/jquery.min.js></script><script type=text/javascript src=/js/search.js></script><script type=text/javascript src=/js/affix.js></script><script type=text/javascript src=/js/scrollspy.js></script><script type=text/javascript>function detectIE(){var ua=window.navigator.userAgent;var msie=ua.indexOf('MSIE ');var trident=ua.indexOf('Trident/');var edge=ua.indexOf('Edge/');if(msie>0||trident>0||edge>0){return-1;}
return 1;}
function getCntViewHeight(){var docHeight=$('#content').height(),winHeight=$(window).height(),cntViewHeight=(docHeight>winHeight)?(docHeight-winHeight):($(document).height()-winHeight);return cntViewHeight;}
function getScrollbarWidth(){var $div=$('<div />').addClass('scrollbar-measure').prependTo('body');var div=$div[0];var scrollbarWidth=div.offsetWidth-div.clientWidth;$div.remove();return scrollbarWidth;}
function registerBackTop(){var THRESHOLD=50;var $top=$('.back-to-top');$(window).on('scroll',function(){$top.toggleClass('back-to-top-on',window.pageYOffset>THRESHOLD);var scrollTop=$(window).scrollTop();var cntViewHeight=getCntViewHeight();var scrollPercent=(scrollTop)/(cntViewHeight);var scrollPercentRounded=Math.round(scrollPercent*100);var scrollPercentMaxed=(scrollPercentRounded>100)?100:scrollPercentRounded;$('#scrollpercent>span').html(scrollPercentMaxed);});$top.on('click',function(){$("html,body").animate({scrollTop:0,screenLeft:0,},800);});}
function initScrollSpy(){var tocSelector='.post-toc';var $tocElement=$(tocSelector);var activeCurrentSelector='.active-current';$tocElement.on('activate.bs.scrollspy',function(){var $currentActiveElement=$(tocSelector+' .active').last();removeCurrentActiveClass();$currentActiveElement.addClass('active-current');}).on('clear.bs.scrollspy',removeCurrentActiveClass);$('body').scrollspy({target:tocSelector});function removeCurrentActiveClass(){$(tocSelector+' '+activeCurrentSelector).removeClass(activeCurrentSelector.substring(1));}}
function initAffix(){var headerHeight=$('.header-inner').height();var footerOffset=parseInt($('.main').css('padding-bottom'),10);var sidebarTop=headerHeight+10;$('.sidebar-inner').affix({offset:{top:sidebarTop,bottom:footerOffset}});$(document).on('affixed.bs.affix',function(){updateTOCHeight(document.body.clientHeight-100);});}
function initTOCDimension(){var updateTOCHeightTimer;$(window).on('resize',function(){updateTOCHeightTimer&&clearTimeout(updateTOCHeightTimer);updateTOCHeightTimer=setTimeout(function(){var tocWrapperHeight=document.body.clientHeight-100;updateTOCHeight(tocWrapperHeight);},0);});updateTOCHeight(document.body.clientHeight-100);var scrollbarWidth=getScrollbarWidth();$('.post-toc').css('width','calc(100% + '+scrollbarWidth+'px)');}
function updateTOCHeight(height){height=height||'auto';$('.post-toc').css('max-height',height);}
$(function(){var sidebarTop=$('.header-inner').height()+10;$('#sidebar').css({'margin-top':sidebarTop}).show();var sidebarMt=parseInt($('#sidebar').css('margin-top'));var sidebarInHeight=parseInt($('.sidebar-inner').css('height'));var sideHeight=sidebarMt+sidebarInHeight;var contentHeight=$('.content-wrap').height();if(contentHeight<sideHeight){$('.content-wrap').css('min-height',sideHeight);}
$('.site-nav-toggle').on('click',function(){var $siteNav=$('.site-nav');var $toggleLine=$('.toggle');var ON_CLASS_NAME='site-nav-on';var CLOSE_CLASS_NAME='toggle-close';var isSiteNavOn=$siteNav.hasClass(ON_CLASS_NAME);var animateAction=isSiteNavOn?'slideUp':'slideDown';var animateCallback=isSiteNavOn?'removeClass':'addClass';$siteNav.stop()[animateAction]('normal',function(){$siteNav[animateCallback](ON_CLASS_NAME);$toggleLine[animateCallback](CLOSE_CLASS_NAME);});});registerBackTop();initScrollSpy();initAffix();initTOCDimension();$('.sidebar-nav-toc').click(function(){$(this).addClass('sidebar-nav-active');$(this).next().removeClass('sidebar-nav-active');$('.'+$(this).next().attr('data-target')).toggle(500);$('.'+$(this).attr('data-target')).toggle(500);});$('.sidebar-nav-overview').click(function(){$(this).addClass('sidebar-nav-active');$(this).prev().removeClass('sidebar-nav-active');$('.'+$(this).prev().attr('data-target')).toggle(500);$('.'+$(this).attr('data-target')).toggle(500);});});</script><script src=//cdn.bootcdn.net/ajax/libs/imageviewer/0.1.0/viewer.min.js></script><script type=text/javascript>$(function(){$('.post-body').viewer();});</script><script type=text/javascript>$(function(){if(detectIE()>0){$.getScript(document.location.protocol+'//cdn.jsdelivr.net/npm/@waline/client/dist/Waline.min.js',function(){new Waline({el:'#wcomments',visitor:true,avatar:'wavatar',avatarCDN:'https://sdn.geekzu.org/avatar/',avatarForce:!1,wordLimit:'200',placeholder:' 欢迎留下您的宝贵建议，请填写您的昵称和邮箱便于后续交流. ^_^ ',requiredFields:['nick','mail'],serverURL:"Your WalineSerURL",lang:"zh-cn"});});}else{$('#wcomments').html('抱歉，Waline插件不支持IE或Edge，建议使用Chrome浏览器。');}});</script><script type=text/javascript src="//s7.addthis.com/js/300/addthis_widget.js#pubid=Your%20AddthisId"></script><script>(function(){var bp=document.createElement('script');var curProtocol=window.location.protocol.split(':')[0];if(curProtocol==='https'){bp.src='https://zz.bdstatic.com/linksubmit/push.js';}
else{bp.src='http://push.zhanzhang.baidu.com/push.js';}
var s=document.getElementsByTagName("script")[0];s.parentNode.insertBefore(bp,s);})();</script></body></html>